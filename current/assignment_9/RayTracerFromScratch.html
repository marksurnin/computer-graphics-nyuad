<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" > 

<title>Draw Square</title>

<script id="vertex-shader" type="x-shader/x-vertex">
precision mediump float;

attribute vec4 vPosition;
varying vec3 fPosition;

void main(){
  gl_Position = vPosition;
  fPosition = vPosition.xyz;
}
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
precision mediump float;

varying vec3 fPosition;

struct Ray {
  vec3 origin;
  // should always be normalized
  vec3 direction;
};

struct Sphere {
  vec3 center;
  float radius;
  int material_id;
};

struct IntersectedObject{
  Sphere sphere;
  // the point where a ray intersects the sphere
  vec3 point;
  // the distance from the ray origin to the spere. -1.0 if no intersection.
  float distance;
};

Sphere sphereList[2];

float intersect(Ray ray, Sphere sphere) {
  float distance, t1, t2; //
  vec3 x = ray.origin - sphere.center; // vec from sphere center to ray origin
  float A = dot(ray.direction, ray.direction); //size^2
  float B = 2.0 * dot(x, ray.direction); // 
  float C = dot(x,x) - sphere.radius * sphere.radius;
  float D = B*B - 4.0*A*C; //b^2 -4ac
  distance = 99999.99;
  if (D >= 0.0){
    float S = sqrt(D); //sqrt(b^2-4ac)
    t1 = (-B - S)/(2.0 * A);
    t2 = (-B + S)/(2.0 * A);
    if (t1 >= 0.0){
      distance = t1;
    }
    if (t2 >= 0.0 && t2 < t1 ){
      distance = t2;
    }
  } else {
    distance = -1.0;
  }
  return distance;
}

IntersectedObject hit(Ray ray) {
  float distanceToTheClosestObject = 9999999.0;
  Sphere tempSphere = Sphere(vec3(0.0, 0.0, 0.0), 0.1, 0);
  vec3 tempPoint = vec3(0.0, 0.0, 0.0);
  // set the distance to -1.0 (default)
  IntersectedObject object = IntersectedObject(tempSphere, tempPoint, -1.0);

  for (int i = 0; i < 2; i++) {
    float distanceToObject = intersect(ray, sphereList[i]);
    if (distanceToObject > 0.0 && distanceToObject < distanceToTheClosestObject) {
      object.sphere = sphereList[i];
      object.distance = distanceToObject;
      object.point = vec3(ray.origin + distanceToObject * ray.direction);

      distanceToTheClosestObject = distanceToObject;
    }
  }

  return object;
}

void main(){
  vec3 cameraPos = vec3(0.0, 0.0, 5.0);
  vec3 d = vec3(vec3(fPosition.xy, 0.0) - cameraPos);
  Ray ray = Ray(cameraPos, normalize(d));

  sphereList[0] = Sphere(vec3(0.0, 0.0, 0.0), 0.3, 0);
  sphereList[1] = Sphere(vec3(0.3, 0.3, -0.1), 0.3, 1);

  IntersectedObject intersectedObject = hit(ray);
  if (intersectedObject.distance > 0.0) {
    if (intersectedObject.sphere.material_id == 0){
      gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
    } else if (intersectedObject.sphere.material_id == 1){
      gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);
    }
  } else {
    gl_FragColor = vec4(0.0, 0.2, 0.0, 1.0);
  }
}

</script>

<script type="text/javascript" src="../../common/webgl-utils.js"></script>
<script type="text/javascript" src="../../common/initShaders.js"></script>
<script type="text/javascript" src="../../common/MV.js"></script>
<script type="text/javascript" src="RayTracerFromScratch.js"></script>
</head>

<body>
<canvas id="gl-canvas" width="512" height="512">
  HTML5 Canvas not supported!
</canvas>
</body>
</html>

